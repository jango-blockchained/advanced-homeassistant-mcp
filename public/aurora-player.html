<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aurora - Sound to Light Player</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    h1 {
      font-size: 3rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .panel {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .panel h2 {
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .file-input-area {
      border: 2px dashed rgba(255, 255, 255, 0.5);
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-input-area:hover {
      border-color: #fff;
      background: rgba(255, 255, 255, 0.05);
    }

    .file-input-area.drag-over {
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.1);
    }

    input[type="file"] {
      display: none;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin: 5px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
    }

    .btn-danger {
      background: linear-gradient(135deg, #f87171 0%, #dc2626 100%);
    }

    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .device-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .device-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .device-card:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .device-card.selected {
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.2);
    }

    .device-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .device-status {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .progress-bar {
      width: 100%;
      height: 30px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4ade80 0%, #22c55e 100%);
      width: 0%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .status-bar {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
    }

    .status-item {
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
    }

    .timeline-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .timeline-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .timeline-item:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .timeline-item.active {
      border: 2px solid #4ade80;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .setting-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .setting-item label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .setting-item input,
    .setting-item select {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 5px;
      padding: 8px;
      color: #fff;
      font-size: 1rem;
    }

    .setting-item input[type="range"] {
      padding: 0;
    }

    .log {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-entry {
      margin: 2px 0;
      padding: 2px 0;
    }

    .log-entry.error {
      color: #f87171;
    }

    .log-entry.success {
      color: #4ade80;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üéµ Aurora</h1>
      <p class="subtitle">Sound-to-Light Synchronization System</p>
    </header>

    <!-- Step 1: Audio Input -->
    <div class="panel">
      <h2>üìÅ Step 1: Select Audio File</h2>
      <div class="file-input-area" id="fileInputArea">
        <div class="file-icon" style="font-size: 3rem;">üéµ</div>
        <p style="margin: 10px 0;">Drag & drop audio file here or click to browse</p>
        <p style="font-size: 0.9rem; opacity: 0.8;">Supported: WAV, MP3, FLAC, OGG</p>
        <input type="file" id="audioFileInput" accept="audio/*">
      </div>
      <div id="selectedFile" class="hidden" style="margin-top: 15px; text-align: center;">
        <strong>Selected:</strong> <span id="fileName"></span>
        <br>
        <input type="text" id="audioFilePath" placeholder="/path/to/audio/file.wav" 
               style="width: 100%; margin-top: 10px; padding: 10px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: #fff;">
      </div>
    </div>

    <!-- Step 2: Select Devices -->
    <div class="panel">
      <h2>üí° Step 2: Select Devices</h2>
      <button class="btn" onclick="loadDevices()">Scan Devices</button>
      <div id="deviceList" class="device-list"></div>
    </div>

    <!-- Step 3: Render Settings -->
    <div class="panel">
      <h2>‚öôÔ∏è Step 3: Configure Settings</h2>
      <div class="settings-grid">
        <div class="setting-item">
          <label for="intensity">Intensity</label>
          <input type="range" id="intensity" min="0" max="1" step="0.1" value="0.7">
          <span id="intensityValue">0.7</span>
        </div>
        <div class="setting-item">
          <label for="colorMapping">Color Mapping</label>
          <select id="colorMapping">
            <option value="frequency">Frequency</option>
            <option value="mood">Mood</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div class="setting-item">
          <label for="brightnessMapping">Brightness Mapping</label>
          <select id="brightnessMapping">
            <option value="amplitude">Amplitude</option>
            <option value="energy">Energy</option>
            <option value="beats">Beats</option>
          </select>
        </div>
        <div class="setting-item">
          <label for="beatSync">
            <input type="checkbox" id="beatSync" checked> Beat Synchronization
          </label>
        </div>
        <div class="setting-item">
          <label for="smoothTransitions">
            <input type="checkbox" id="smoothTransitions" checked> Smooth Transitions
          </label>
        </div>
      </div>
      <div style="margin-top: 20px; text-align: center;">
        <button class="btn btn-primary" onclick="analyzeAndRender()" id="renderBtn" disabled>
          üé® Analyze & Render Timeline
        </button>
      </div>
      <div id="renderProgress" class="hidden">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill">0%</div>
        </div>
      </div>
    </div>

    <!-- Step 4: Playback Controls -->
    <div class="panel">
      <h2>‚ñ∂Ô∏è Step 4: Playback</h2>
      <div class="controls">
        <button class="btn btn-primary" onclick="play()" id="playBtn" disabled>‚ñ∂Ô∏è Play</button>
        <button class="btn" onclick="pause()" id="pauseBtn" disabled>‚è∏Ô∏è Pause</button>
        <button class="btn" onclick="resume()" id="resumeBtn" disabled>‚ñ∂Ô∏è Resume</button>
        <button class="btn btn-danger" onclick="stop()" id="stopBtn" disabled>‚èπÔ∏è Stop</button>
      </div>
      <div class="status-bar">
        <div class="status-item">
          <span>Status:</span>
          <span id="statusState">Idle</span>
        </div>
        <div class="status-item">
          <span>Position:</span>
          <span id="statusPosition">0.0s</span>
        </div>
        <div class="status-item">
          <span>Commands:</span>
          <span id="statusCommands">Q:0 X:0 F:0</span>
        </div>
      </div>
    </div>

    <!-- Saved Timelines -->
    <div class="panel">
      <h2>üìö Saved Timelines</h2>
      <button class="btn" onclick="loadTimelines()">Refresh List</button>
      <div id="timelineList" class="timeline-list"></div>
    </div>

    <!-- Log -->
    <div class="panel">
      <h2>üìù Activity Log</h2>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE = window.location.origin;
    
    // State
    let selectedDevices = [];
    let currentTimeline = null;
    let statusUpdateInterval = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupFileInput();
      loadDevices();
      loadTimelines();
      
      // Update intensity display
      document.getElementById('intensity').addEventListener('input', (e) => {
        document.getElementById('intensityValue').textContent = e.target.value;
      });
    });

    // File input setup
    function setupFileInput() {
      const area = document.getElementById('fileInputArea');
      const input = document.getElementById('audioFileInput');
      
      area.addEventListener('click', () => input.click());
      
      area.addEventListener('dragover', (e) => {
        e.preventDefault();
        area.classList.add('drag-over');
      });
      
      area.addEventListener('dragleave', () => {
        area.classList.remove('drag-over');
      });
      
      area.addEventListener('drop', (e) => {
        e.preventDefault();
        area.classList.remove('drag-over');
        if (e.dataTransfer.files.length) {
          handleFileSelect(e.dataTransfer.files[0]);
        }
      });
      
      input.addEventListener('change', (e) => {
        if (e.target.files.length) {
          handleFileSelect(e.target.files[0]);
        }
      });
    }

    function handleFileSelect(file) {
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('selectedFile').classList.remove('hidden');
      document.getElementById('audioFilePath').value = file.path || '';
      updateRenderButton();
      log(`Selected: ${file.name}`, 'success');
    }

    // Device management
    async function loadDevices() {
      try {
        log('Scanning devices...');
        const response = await fetch(`${API_BASE}/aurora/devices`);
        const data = await response.json();
        
        const deviceList = document.getElementById('deviceList');
        deviceList.innerHTML = '';
        
        data.devices.forEach(device => {
          const card = document.createElement('div');
          card.className = 'device-card';
          card.innerHTML = `
            <div class="device-name">${device.name}</div>
            <div class="device-status">${device.state} ‚Ä¢ ${device.entityId}</div>
          `;
          card.addEventListener('click', () => toggleDevice(device.entityId, card));
          deviceList.appendChild(card);
        });
        
        log(`Found ${data.devices.length} devices`, 'success');
      } catch (error) {
        log(`Error loading devices: ${error.message}`, 'error');
      }
    }

    function toggleDevice(entityId, card) {
      const index = selectedDevices.indexOf(entityId);
      if (index > -1) {
        selectedDevices.splice(index, 1);
        card.classList.remove('selected');
      } else {
        selectedDevices.push(entityId);
        card.classList.add('selected');
      }
      updateRenderButton();
      log(`${index > -1 ? 'Deselected' : 'Selected'}: ${entityId}`);
    }

    function updateRenderButton() {
      const hasFile = document.getElementById('audioFilePath').value !== '';
      const hasDevices = selectedDevices.length > 0;
      document.getElementById('renderBtn').disabled = !(hasFile && hasDevices);
    }

    // Analyze and render
    async function analyzeAndRender() {
      const audioFile = document.getElementById('audioFilePath').value;
      if (!audioFile || selectedDevices.length === 0) {
        log('Please select audio file and devices', 'error');
        return;
      }

      try {
        log('Starting analysis and rendering...');
        document.getElementById('renderProgress').classList.remove('hidden');
        document.getElementById('renderBtn').disabled = true;
        
        // Render timeline
        const settings = {
          intensity: parseFloat(document.getElementById('intensity').value),
          colorMapping: document.getElementById('colorMapping').value,
          brightnessMapping: document.getElementById('brightnessMapping').value,
          beatSync: document.getElementById('beatSync').checked,
          smoothTransitions: document.getElementById('smoothTransitions').checked,
        };
        
        updateProgress(50, 'Rendering timeline...');
        
        const response = await fetch(`${API_BASE}/aurora/render`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            audioFile,
            devices: selectedDevices,
            settings,
            name: `Timeline ${new Date().toLocaleString()}`
          })
        });
        
        const data = await response.json();
        currentTimeline = data.timeline;
        
        updateProgress(100, 'Complete!');
        log(`Timeline rendered: ${data.timeline.tracks.length} tracks`, 'success');
        
        document.getElementById('playBtn').disabled = false;
        loadTimelines();
        
        setTimeout(() => {
          document.getElementById('renderProgress').classList.add('hidden');
          updateProgress(0, '');
        }, 2000);
      } catch (error) {
        log(`Error rendering: ${error.message}`, 'error');
        updateProgress(0, '');
      } finally {
        document.getElementById('renderBtn').disabled = false;
      }
    }

    function updateProgress(percent, text) {
      const fill = document.getElementById('progressFill');
      fill.style.width = `${percent}%`;
      fill.textContent = text || `${percent}%`;
    }

    // Playback controls
    async function play() {
      if (!currentTimeline) {
        log('No timeline loaded', 'error');
        return;
      }

      try {
        log('Starting playback...');
        const response = await fetch(`${API_BASE}/aurora/play`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ timelineId: currentTimeline.id })
        });
        
        const data = await response.json();
        log('Playback started', 'success');
        
        document.getElementById('playBtn').disabled = true;
        document.getElementById('pauseBtn').disabled = false;
        document.getElementById('stopBtn').disabled = false;
        
        startStatusUpdates();
      } catch (error) {
        log(`Error starting playback: ${error.message}`, 'error');
      }
    }

    async function pause() {
      try {
        await fetch(`${API_BASE}/aurora/pause`, { method: 'POST' });
        log('Playback paused');
        document.getElementById('pauseBtn').disabled = true;
        document.getElementById('resumeBtn').disabled = false;
      } catch (error) {
        log(`Error pausing: ${error.message}`, 'error');
      }
    }

    async function resume() {
      try {
        await fetch(`${API_BASE}/aurora/resume`, { method: 'POST' });
        log('Playback resumed', 'success');
        document.getElementById('resumeBtn').disabled = true;
        document.getElementById('pauseBtn').disabled = false;
      } catch (error) {
        log(`Error resuming: ${error.message}`, 'error');
      }
    }

    async function stop() {
      try {
        await fetch(`${API_BASE}/aurora/stop`, { method: 'POST' });
        log('Playback stopped');
        
        document.getElementById('playBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = true;
        document.getElementById('resumeBtn').disabled = true;
        document.getElementById('stopBtn').disabled = true;
        
        stopStatusUpdates();
        updateStatus({ state: 'stopped', position: 0, queueStats: { queued: 0, executed: 0, failed: 0 } });
      } catch (error) {
        log(`Error stopping: ${error.message}`, 'error');
      }
    }

    // Status updates
    function startStatusUpdates() {
      if (statusUpdateInterval) return;
      statusUpdateInterval = setInterval(updateStatusFromServer, 500);
    }

    function stopStatusUpdates() {
      if (statusUpdateInterval) {
        clearInterval(statusUpdateInterval);
        statusUpdateInterval = null;
      }
    }

    async function updateStatusFromServer() {
      try {
        const response = await fetch(`${API_BASE}/aurora/status`);
        const data = await response.json();
        updateStatus(data.state);
      } catch (error) {
        // Ignore errors during status updates
      }
    }

    function updateStatus(state) {
      document.getElementById('statusState').textContent = state.state || 'idle';
      document.getElementById('statusPosition').textContent = `${(state.position || 0).toFixed(1)}s`;
      document.getElementById('statusCommands').textContent = 
        `Q:${state.queueStats?.queued || 0} X:${state.queueStats?.executed || 0} F:${state.queueStats?.failed || 0}`;
    }

    // Timelines
    async function loadTimelines() {
      try {
        const response = await fetch(`${API_BASE}/aurora/timelines`);
        const data = await response.json();
        
        const list = document.getElementById('timelineList');
        list.innerHTML = '';
        
        if (!data.timelines || data.timelines.length === 0) {
          list.innerHTML = '<p style="opacity: 0.7; text-align: center; padding: 20px;">No saved timelines</p>';
          return;
        }
        
        data.timelines.forEach(timeline => {
          const item = document.createElement('div');
          item.className = 'timeline-item';
          if (currentTimeline?.id === timeline.id) {
            item.classList.add('active');
          }
          item.innerHTML = `
            <div>
              <strong>${timeline.name}</strong><br>
              <small>${timeline.deviceCount} devices ‚Ä¢ ${timeline.commandCount} commands ‚Ä¢ ${timeline.duration.toFixed(1)}s</small>
            </div>
            <button class="btn" onclick="selectTimeline('${timeline.id}')">Load</button>
          `;
          list.appendChild(item);
        });
      } catch (error) {
        log(`Error loading timelines: ${error.message}`, 'error');
      }
    }

    async function selectTimeline(id) {
      try {
        const response = await fetch(`${API_BASE}/aurora/timelines`);
        const data = await response.json();
        currentTimeline = data.timelines.find(t => t.id === id);
        document.getElementById('playBtn').disabled = false;
        log(`Timeline loaded: ${currentTimeline.name}`, 'success');
        loadTimelines(); // Refresh to show active
      } catch (error) {
        log(`Error selecting timeline: ${error.message}`, 'error');
      }
    }

    // Logging
    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const time = new Date().toLocaleTimeString();
      entry.textContent = `[${time}] ${message}`;
      logEl.insertBefore(entry, logEl.firstChild);
      
      // Keep only last 100 entries
      while (logEl.children.length > 100) {
        logEl.removeChild(logEl.lastChild);
      }
    }
  </script>
</body>
</html>
